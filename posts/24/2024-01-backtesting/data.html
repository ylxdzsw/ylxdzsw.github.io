<nattoppet-card data-title="数据">
    <button class="data-builtin" data-name="bitfinex_btcusd_1d">比特币-美元(Bitfinex)</button>
    <button class="data-builtin" data-name="hkex_etf_csop_hs_tech">南方恒生科技(3033.HK)</button>
    <button class="data-builtin" data-name="aapl">苹果(AAPL)</button>
    <button class="data-builtin" data-name="ndx100">纳斯达克100(^NDX)</button>
    <button class="data-builtin" data-name="sa405_15m">纯碱2405</button>
    <button class="data-builtin" data-name="sh513130_1d">恒生科技ETF</button>
    <button id="data-load-csv">本地CSV文件</button>
    <button id="data-load-json">本地JSON文件</button>
</nattoppet-card>

<style>
    nattoppet-card[data-title="数据"] {
        text-align: left;
        line-height: 1.9;
    }
    nattoppet-card[data-title="数据"] > button {
        font-size: .9rem;
    }
</style>

<script type="module">
    const card = document.querySelector('nattoppet-card[data-title="数据"]')

    document.querySelectorAll('.data-builtin').forEach(button => {
        button.addEventListener('click', () => {
            const name = button.dataset.name
            app.emit('data-load', window[name])
        })
    })

    // TODO: make it a folable menu under DATA panel
    function load_csv(str, {
        strip_start = 0,
        strip_end = 0,
        open = null,
        high = null,
        low = null,
        close = null,
        volume = null,
        timestamp = null,
        timestamp_callback = parseInt
    }) {
        const lines = str.split('\n').slice(strip_start, -strip_end)
        const data = []
        for (let line of lines) {
            const cells = line.split(',').map(cell => cell.trim())
            const item = {}
            if (open != null) item.open = parseFloat(cells[open])
            if (high != null) item.high = parseFloat(cells[high])
            if (low != null) item.low = parseFloat(cells[low])
            if (close != null) item.close = parseFloat(cells[close])
            if (volume != null) item.volume = parseFloat(cells[volume])
            if (timestamp != null) item.timestamp = timestamp_callback(cells[timestamp])
            data.push(item)
        }
        return data
    }

    document.getElementById('data-load-csv').addEventListener('click', () => {
        alert("这个功能还没做")
    })

    document.getElementById('data-load-json').addEventListener('click', () => {
        const file_input = document.createElement('input')
        file_input.type = 'file'
        file_input.accept = 'application/json'
        file_input.addEventListener('change', () => {
            const file = file_input.files[0]
            const reader = new FileReader()
            reader.onload = () => {
                try {
                    const data = JSON.parse(reader.result)
                    if (!Array.isArray(data) || data.length == 0 || data[0].timestamp == null || data[0].open == null || data[0].high == null || data[0].low == null || data[0].close == null) {
                        throw new Error()
                    }
                    app.emit('data-load', data)
                    app.log(data.length + '条数据加载成功')
                } catch {
                    alert('数据格式不正确')
                }
            }
            reader.readAsText(file)
        })
        file_input.click()
    })

    app.on("data-load", card._on_data_load = data => {
        app.active_dataset = data
    })

    app.on('load', card._on_load = () => {
        const saved_data = localStorage.getItem('data')
        if (saved_data)
            app.emit('data-load', JSON.parse(saved_data))
        else
            document.querySelector('.data-builtin').click()
    })

    app.on('save', card._on_save = () => {
        localStorage.setItem('data', JSON.stringify(app.active_dataset))
    })
</script>
