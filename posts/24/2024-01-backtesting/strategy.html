<nattoppet-card data-title="策略">
    <textarea id="strategy-editor" style="height: 300px; width: 100%;"></textarea> <br>
    <button id="run-backtest">跑回测</button>
    <button id="run-backtest-random">随机截取一段时间跑</button>
    <button id="strategy-share">生成分享链接</button>
    <button id="strategy-builder">图形化策略构建器</button>
    <details style="margin-top: .5em;">
        <summary>示例策略</summary>
        <div style="margin: .5rem 0 1rem;">
        <button class="strategy-builtin" data-code="// 连续三天上涨&#13;if (t(0).close > t(0).open)&#13;if (t(-1).close > t(-1).open)&#13;if (t(-2).close > t(-2).open)&#13;if (t(-3).close <= t(-3).open)&#13;    buy()&#13;// 赚或亏超过10%&#13;if (profit > 0.1 || profit < -0.1)&#13;    sell()">倒钱一号</button>
        <button class="strategy-builtin" data-code="if (price >= MA(5) && t(-1).price < t(-1).MA(5)) buy()&#13;if (profit > 0.05 || profit < -0.05) sell()&#13;if (price < MA(5)) sell()">倒钱二号</button>
        <button class="strategy-builtin" data-code="buy()">持仓到死</button>
        <button class="strategy-builtin" data-code="Math.random() < 0.1 && buy()&#13;profit > 0.1 && sell()">随机买</button>
        </div>
    </details>
    <details>
        <summary>帮助</summary>
        <p>策略是一段JavaScript代码，它会在每个交易日结束时执行。</p>
        <ul>
            <li><code>price</code>：当前价格（即<code>t(0).close</code>）
            <li><code>profit</code>：当前持仓收益率，例如-0.05就是亏损5%。没有持仓就是0。
            <li><code>profit_annualized</code>：当前持仓年化收益率。
            <li><code>cash</code>：当前现金。开局一万。
            <li><code>holding</code>：当前持仓。
            <li><code>holding_days</code>：当前持仓天数。
            <li><code>holding_price</code>：当前持仓成本价。
            <li><code>buy()</code>：买入。若无现金则无动作。
            <li><code>sell()</code>：卖出。若无持仓则无动作。
            <li><code>log(msg)</code>：打印日志。
            <li><code>t(n)</code>：<code>n</code>天前的数据，例如<code>t(-1).high</code>是昨天的最高价。
            <li><code>open</code>：开盘价。
            <li><code>high</code>：最高价。
            <li><code>low</code>：最低价。
            <li><code>close</code>：收盘价。
            <li><code>volume</code>：成交量。有些数据集没有。
            <li><code>MA(n)</code>：<code>n</code>日简单移动平均，例如<code>MA(5)</code>是5日均线。<code>t(-2).MA(5)</code>是前天的5日均线。
            <li><code>EMA(n)</code>：<code>n</code>日指数移动平均。
            <li><code>DIF(fast, slow)</code>：<code>EMA(fast) - EMA(slow)</code>。
            <li><code>DEA(fast, slow, n)</code>：<code>DIF(fast, slow)</code>的<code>n</code>日指数移动平均。
            <li><code>MACD(fast, slow, n)</code>：<code>DIF(fast, slow) - DEA(fast, slow, n)</code>
            <li><code>RSI(n)</code>：一个指标。
        </ul>
    </details>
    <details>
        <summary>高级</summary>
        <div><label>日志记录交易<input type="checkbox" id="strategy-options-verbose" checked></label></div>
        <button id="run-bootstrapping">从当前数据随机截取10000次跑</button><br>
        <button id="run-bootstrapping-all">从所有数据集里随机截取10000次跑</button><br>
        <progress id="bootstrapping-progress" class="hidden" value="0" max="1"></progress>
    </details>
</nattoppet-card>

<style>
    nattoppet-card[data-title="策略"] code {
        color: #c7254e;
    }
    nattoppet-card[data-title="策略"] details li {
        font-size: .9rem;
    }
    .hidden {
        display: none;
    }
</style>

<script type="module">
    const code_mirror = CodeMirror.fromTextArea(document.getElementById('strategy-editor'), {
        lineNumbers: true,
        indentUnit: 2,
    })

    code_mirror.on('change', () => {
        app.emit('strategy-change', code_mirror.getValue())
    })

    app.on('strategy-load', code_mirror._on_strategy_load = code => {
        code_mirror.setValue(code)
    })

    document.querySelectorAll('.strategy-builtin').forEach(button => {
        button.addEventListener('click', () => {
            const code = button.dataset.code
            app.emit('strategy-load', code)
        })
    })

    document.getElementById('run-backtest').addEventListener('click', async () => {
        try {
            const result = await app.backtest(code_mirror.getValue(), get_options())
            app.log(app.analyze_backtest_result(result))
        } catch (e) {
            app.log("策略运行出错。错误信息：" + e)
        }
    })

    document.getElementById('run-backtest-random').addEventListener('click', async () => {
        const data = app.active_dataset
        const start_index = Math.floor(Math.random() * (data.length - 100))
        const end_index = start_index + 100 + Math.floor(Math.random() * (data.length - start_index - 100))
        try {
            const result = await app.backtest(code_mirror.getValue(), {
                candles: data.slice(start_index, end_index),
                ...get_options()
            })
            app.log(app.analyze_backtest_result(result))
        } catch (e) {
            app.log("策略运行出错。错误信息：" + e)
        }
    })

    document.getElementById('run-bootstrapping').addEventListener('click', async () => {
        const results = []
        document.getElementById('bootstrapping-progress').classList.remove('hidden')
        try {
            for (let i = 0; i < 10000; i++) {
                if (i % 100 == 0) {
                    document.getElementById('bootstrapping-progress').value = i / 10000
                    await new Promise(resolve => setTimeout(resolve, 0))
                }

                const start_index = Math.floor(Math.random() * (app.active_dataset.length - 100))
                const end_index = start_index + 100 + Math.floor(Math.random() * (app.active_dataset.length - start_index - 100))
                try {
                    const result = await app.backtest(code_mirror.getValue(), {
                        candles: app.active_dataset.slice(start_index, end_index),
                        silent: true,
                        ...get_options()
                    })
                    results.push(result)
                } catch (e) {
                    app.log("策略运行出错。错误信息：" + e)
                    return
                }
            }
            const annualized_profits = results.map(history => {
                const total_profit = history[history.length - 1].cash_after_action / 10000 - 1
                return 1 * Math.pow(1 + total_profit, 365 / history.length) - 1
            })

            const avg = annualized_profits.reduce((a, b) => a + b) / annualized_profits.length
            const std = Math.sqrt(annualized_profits.map(x => Math.pow(x - avg, 2)).reduce((a, b) => a + b) / (annualized_profits.length - 1))

            app.log(`平均年化收益率：${(avg * 100).toFixed(2)}%，标准差：${(std * 100).toFixed(2)}%`)
        } finally {
            document.getElementById('bootstrapping-progress').classList.add('hidden')
        }
    })

    document.getElementById('run-bootstrapping-all').addEventListener('click', async () => {
        const datasets = Array.from(document.querySelectorAll('.data-builtin')).map(button => window[button.dataset.name])
        const results = []
        document.getElementById('bootstrapping-progress').classList.remove('hidden')
        try {
            for (let i = 0; i < 10000; i++) {
                if (i % 100 == 0) {
                    document.getElementById('bootstrapping-progress').value = i / 10000
                    await new Promise(resolve => setTimeout(resolve, 0))
                }

                const data = datasets[Math.floor(Math.random() * datasets.length)]
                const start_index = Math.floor(Math.random() * (data.length - 100))
                const end_index = start_index + 100 + Math.floor(Math.random() * (data.length - start_index - 100))
                try {
                    const result = await app.backtest(code_mirror.getValue(), {
                        candles: data.slice(start_index, end_index),
                        silent: true,
                        ...get_options()
                    })
                    results.push(result)
                } catch (e) {
                    app.log("策略运行出错。错误信息：" + e)
                    return
                }
            }
            const annualized_profits = results.map(history => {
                const total_profit = history[history.length - 1].cash_after_action / 10000 - 1
                return 1 * Math.pow(1 + total_profit, 365 / history.length) - 1
            })

            const avg = annualized_profits.reduce((a, b) => a + b) / annualized_profits.length
            const std = Math.sqrt(annualized_profits.map(x => Math.pow(x - avg, 2)).reduce((a, b) => a + b) / (annualized_profits.length - 1))

            app.log(`平均年化收益率：${(avg * 100).toFixed(2)}%，标准差：${(std * 100).toFixed(2)}%`)
        } finally {
            document.getElementById('bootstrapping-progress').classList.add('hidden')
        }
    })

    document.getElementById('strategy-share').addEventListener('click', async () => {
        const encoded = new TextEncoder().encode(code_mirror.getValue())
        const compressor = new CompressionStream('deflate-raw')
        const writer = compressor.writable.getWriter()
        writer.write(encoded).then(() => writer.close())
        const compressed = await new Response(compressor.readable).arrayBuffer()
        const base64 = btoa(String.fromCharCode(...new Uint8Array(compressed)))
        const url_safe_base64 = base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '')
        const url = new URL(location.href)
        url.searchParams.set('strategy', url_safe_base64)
        navigator.clipboard.writeText(url.href)
        alert('已复制分享链接到剪贴板')
    })

    document.getElementById('strategy-builder').addEventListener('click', () => {
        window.open("https://blog.ylxdzsw.com/2024-01-backtesting-builder.html", "_blank")
    })

    app.on('load', code_mirror._on_load = async () => {
        const saved_options = localStorage.getItem('strategy-options')
        if (saved_options)
            set_options(JSON.parse(saved_options))

        const url = new URL(location.href)
        const shared_strategy = url.searchParams.get('strategy')
        if (shared_strategy) {
            const url_safe_base64 = shared_strategy.replace(/-/g, '+').replace(/_/g, '/')
            const compressed = Uint8Array.from(atob(url_safe_base64), c => c.charCodeAt(0))
            const decompressor = new DecompressionStream('deflate-raw')
            const writer = decompressor.writable.getWriter()
            writer.write(compressed).then(() => writer.close())
            const code = await new Response(decompressor.readable).text()
            app.emit('strategy-load', code)
            return
        }

        const saved_strategy = localStorage.getItem('strategy')
        if (saved_strategy)
            app.emit('strategy-load', saved_strategy)
        else
            document.querySelector('.strategy-builtin').click()
    })

    app.on('save', code_mirror._on_save = () => {
        localStorage.setItem('strategy', code_mirror.getValue())
        localStorage.setItem('strategy-options', JSON.stringify(get_options()))
    })

    function get_options() {
        return {
            verbose: document.getElementById('strategy-options-verbose').checked,
        }
    }

    function set_options(options) {
        document.getElementById('strategy-options-verbose').checked = options.verbose ?? true
    }
</script>
